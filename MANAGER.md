# Инструкция для менеджера

Этот файл — краткая инструкция для менеджера салона по работе с ботом и таблицей Google Sheets.

## Кому полезно

- Менеджеру, который хочет просматривать записи, блокировать время и получать уведомления о новых/отменённых записях.

## Включение менеджерских уведомлений

1. В `.env` (или в переменных окружения на сервере) задайте `MANAGER_CHAT_ID` равным вашему Telegram chat id.
2. Если `MANAGER_CHAT_ID` не задан, уведомления менеджера не отправляются.

Как получить свой Chat ID (простые варианты):

- В Telegram найдите бота `@userinfobot` или `@getidsbot`, нажмите Start — бот покажет ваш id.
- Либо попросите разработчика временно включить логирование `ctx.from.id` при вашем сообщении в бота.

После установки `MANAGER_CHAT_ID` и перезапуска бота вы будете получать уведомления о новых записи и об отменах.

## Просмотр записей

- Откройте Google Sheets, указанный в `GOOGLE_SHEETS_ID`.
- Лист `Записи` содержит все записи. Отфильтруйте по столбцу `Статус` = `активна` и дате.
- Полезные столбцы: `ID_записи`, `Услуга`, `Дата`, `Время_начала`, `Время_окончания`, `Имя_клиента`, `Телефон`, `Username_Telegram`, `Комментарий`, `Код_отмены`.

## Работа в боте — админ‑режим

- Откройте диалог с ботом и выполните команду `/admin`. Команда активна только для аккаунта, чей `id` совпадает с `MANAGER_CHAT_ID`.
- В админ‑режиме бот показывает reply‑клавиатуру с пунктами:
  - `Просмотр записей` — показать активные записи (первые 50 строк);
  - `Статистика` — краткая статистика: количество активных записей и число клиентов в базе;
  - `Отменить запись (по ID)` — введите ID записи для отмены (после ввода бот подтвердит и, при наличии `telegram_id` клиента, уведомит его);
  - `Забанить пользователя` — введите Telegram ID или `@username`; если найден по username, будет использован `telegram_id` из таблицы `Clients`;
  - `Разбанить пользователя` — введите Telegram ID для снятия блокировки;
  - `Массовая рассылка` — введите текст рассылки, получите предпросмотр (количество получателей и примеры), затем подтвердите или отмените отправку.
  - `Вернуться в пользовательский режим` — переключиться обратно на обычную клавиатуру клиента.

Примечание: все текстовые операции (ввод ID, текста рассылки и т.п.) ожидают ввода после выбора соответствующего пункта клавиатуры; отмена текущего админ‑действия — команда `/admin_cancel`.

## Отмена записи вручную

1. В `Записи` найдите строку с `ID_записи` нужной записи.
2. В колонке `Статус` установите `отменена`.
3. В колонке `Отменено_UTC` впишите текущее время в формате ISO (например: `2025-12-23T10:30:00Z`).
4. (Опционально) отправьте клиенту сообщение вручную, если нужно; бот отправит уведомление, только если отмену сделает клиент через интерфейс.

> Примечание: корректная ручная отмена нужна, чтобы система не предлагала занятые слоты и чтобы отчёты были точными.

## Статусы записей

- `активна` — запись активна, клиент ожидает услугу
- `отменена` — запись отменена клиентом или администратором
- `исполнено` — услуга оказана, запись автоматически завершена
- `заблокировано` — время заблокировано для записи

## Автоматическое завершение записей

Система автоматически обновляет статус записей на "исполнено" сразу после окончания времени услуги. Проверка происходит каждые 30 минут.

**Новая колонка в листе "Записи":**

- `Исполнено_UTC` — дата и время отметки об исполнении (формат ISO UTC)

## Блокировка слотов (закрыть время для записи)

Блокировка производится через лист `Расписание`. Ниже — подробные правила формата и примеры.

**Формат строки (колонки в таблице):** `Дата | Время_начала | Время_окончания | Статус | Услуга | Примечание`

- `Дата` — дата в формате `YYYY-MM-DD` (пример: `2025-12-24`).
- `Время_начала` / `Время_окончания` — время в 24‑часовом формате `HH:MM` (пример: `13:00`, `09:30`). Часы и минуты должны быть с ведущими нулями.
- `Статус` — значение `заблокировано` (строго). Только строки со `Статус = заблокировано` учитываются как блокировка.
- `Услуга` — опционально; можно оставить пустым или указать причину/услугу (например, `ВСЕ` или `ВЫХОД`).
- `Примечание` — короткое пояснение для менеджеров (например, `перерыв`, `праздник`, `ремонт`).

**Практические примеры** (вставлять начиная со строки 2, под заголовком):

- Блокировка обеда 24 декабря с 13:00 до 14:00:
  - `2025-12-24 | 13:00 | 14:00 | заблокировано | | перерыв на обед`
- Блокировка всего дня (закрыть запись на весь день):
  - `2025-12-31 | 00:00 | 23:59 | заблокировано | | закрыто на Новый год`

**Как отменить блокировку:**

- Удалите соответствующую строку из `Расписание` или измените `Статус` на любое значение, отличное от `заблокировано` (например, оставьте пустым или `открыто`). После этого слот снова будет считаться доступным.

**Важные нюансы:**

- Времена и даты интерпретируются в таймзоне салона (см. `Настройки.таймзона` или `DEFAULT_TIMEZONE` в `.env`). Убедитесь, что задаёте время в правильной таймзоне.
- Изменения в листе вступают в силу почти сразу, но система использует кэш дней с TTL ≈ 60 секунд — возможна небольшая задержка (до ~1 минуты).
- Для блокировки нескольких промежутков подряд добавляйте отдельные строки для каждого интервала.
- Не используйте пересекающиеся блокировки с существующими записями без предварительной договорённости с клиентами — это не отменяет уже подтверждённые записи автоматически.

Если нужна помощь — напишите разработчику, и он подскажет формат или внесёт массовые блокировки.

## Таймзона салона

- Таймзона хранится в листе `Настройки` ключом `таймзона`. Если там нет значения, используется `DEFAULT_TIMEZONE` из `.env`.
- Для корректных напоминаний и отображения дат/времён убедитесь, что `таймзона` задана корректно (например: `Europe/Moscow`, `Asia/Yekaterinburg`).

## Структура Google Sheets

- `Настройки` — ключ/значение (колонки: `Ключ`, `Значение`)
- `Расписание` — колонки: `Дата`, `Время_начала`, `Время_окончания`, `Статус`, `Услуга`, `Примечание`
- `Записи` — колонки: `ID_записи`, `Создано_UTC`, `Услуга`, `Дата`, `Время_начала`, `Время_окончания`, `Имя_клиента`, `Телефон`, `Username_Telegram`, `Комментарий`, `Статус`, `Код_отмены`, `Telegram_ID`, `Chat_ID`, `Отменено_UTC`, `Исполнено_UTC`
- `Клиенты` — колонки: `ID_клиента`, `Первое_посещение_UTC`, `Telegram_ID`, `Username_Telegram`, `Имя`, `Телефон`, `Последняя_запись_UTC`, `Всего_записей`

## Рабочие часы (лист `WorkHours`)

Новый лист `WorkHours` позволяет задать часы работы по дням недели и/или отдельные исключения по конкретным датам.

Колонки (заголовок должен быть в первой строке):

- `Дата` — опционально, конкретная дата в формате `YYYY-MM-DD`. Если заполнено, имеет приоритет над `День_недели`.
- `День_недели` — опционально, короткое обозначение дня недели (например: `mon`, `tue`, `wed` или русское `пн`, `вт` и т.п.). Используется, когда `Дата` не заполнена.
- `Время_начала` — в формате `HH:MM` (например, `09:00`).
- `Время_окончания` — в формате `HH:MM` (например, `18:00`).
- `Обед_начало` — опционально, начало обеда в формате `HH:MM` (например, `13:00`).
- `Обед_окончание` — опционально, конец обеда в формате `HH:MM` (например, `14:00`).

Правило приоритетов:

- Если для конкретной `Дата` задана запись — она имеет приоритет и применяется в первую очередь.
- Если для даты нет записи, используется строка по `День_недели`.
- Если нет ни той, ни другой записи — считается, что день закрыт для записи.

Примеры (вставлять со строки 2):

- Рабочие часы по понедельникам: ` | mon | 10:00 | 20:00`
- Специальные часы на 2025-05-01: `2025-05-01 |  | 12:00 | 16:00`
- Рабочие часы по понедельникам с обедом: ` | mon | 10:00 | 20:00 | 13:00 | 14:00`
- Специальные часы на 2025-05-01 с обедом: `2025-05-01 |  | 12:00 | 16:00 | 13:00 | 14:00`

Примечание:

- Менеджер может редактировать этот лист напрямую в Google Sheets; изменения применяются почти моментально (с учётом кэша ≈ 2 минуты).
- Формат времени должен быть корректным `HH:MM`. Некорректные строки будут игнорироваться и день может считаться закрытым.

## Если уведомления не приходят

- Проверьте, что в `.env` задан `MANAGER_CHAT_ID`.
- Убедитесь, что бот запущен (`node index.js` или через process manager) и что бот не заблокирован вашим аккаунтом.
- Проверьте логи бота на предмет ошибок (доступ к логам есть у разработчика/администратора сервера).

## Перезапуск бота (Windows / PowerShell)

```powershell
# простой запуск
node index.js

# если используете pm2 (рекомендовано для продакшена):
pm2 restart barber-bot
pm2 start index.js --name barber-bot
```
