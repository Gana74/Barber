# Инструкция для менеджера

Этот файл — краткая инструкция для менеджера салона по работе с ботом и таблицей Google Sheets.

## Кому полезно

- Менеджеру, который хочет просматривать записи, блокировать время и получать уведомления о новых/отменённых записях.

## Включение менеджерских уведомлений

1. В `.env` (или в переменных окружения на сервере) задайте `MANAGER_CHAT_ID` равным вашему Telegram chat id.
2. Если `MANAGER_CHAT_ID` не задан, уведомления менеджера не отправляются.

Как получить свой Chat ID (простые варианты):

- В Telegram найдите бота `@userinfobot` или `@getidsbot`, нажмите Start — бот покажет ваш id.
- Либо попросите разработчика временно включить логирование `ctx.from.id` при вашем сообщении в бота.

После установки `MANAGER_CHAT_ID` и перезапуска бота вы будете получать уведомления о новых записях и об отменах.

## Просмотр записей

- Откройте Google Sheets, указанный в `GOOGLE_SHEETS_ID`.
- Лист `Appointments` содержит все записи. Отфильтруйте по столбцу `status` = `active` и дате.
- Полезные столбцы: `id`, `service`, `date`, `time_start`, `time_end`, `client_name`, `phone`, `username`, `comment`, `cancel_code`.

## Отмена записи вручную

1. В `Appointments` найдите строку с `id` нужной записи.
2. В колонке `status` установите `cancelled`.
3. В колонке `cancelled_at_utc` впишите текущее время в формате ISO (например: `2025-12-23T10:30:00Z`).
4. (Опционально) отправьте клиенту сообщение вручную, если нужно; бот отправит уведомление, только если отмену сделает клиент через интерфейс.

> Примечание: корректная ручная отмена нужна, чтобы система не предлагала занятые слоты и чтобы отчёты были точными.

## Блокировка слотов (закрыть время для записи)

Блокировка производится через лист `Schedule`. Ниже — подробные правила формата и примеры.

Формат строки (колонки в таблице): `date | time_start | time_end | status | service | note`

- `date` — дата в формате `YYYY-MM-DD` (пример: `2025-12-24`).
- `time_start` / `time_end` — время в 24‑часовом формате `HH:MM` (пример: `13:00`, `09:30`). Часы и минуты должны быть с ведущими нулями.
- `status` — значение `blocked` (строго). Только строки со `status = blocked` учитываются как блокировка.
- `service` — опционально; можно оставить пустым или указать причину/услугу (например, `ALL` или `ВЫХОД`).
- `note` — короткое пояснение для менеджеров (например, `перерыв`, `праздник`, `ремонт`).

Практические примеры (вставлять начиная со строки 2, под заголовком):

- Блокировка обеда 24 декабря с 13:00 до 14:00:
  - `2025-12-24 | 13:00 | 14:00 | blocked | | перерыв на обед`
- Блокировка всего дня (закрыть запись на весь день):
  - `2025-12-31 | 00:00 | 23:59 | blocked | | закрыто на Новый год`

Как отменить блокировку:

- Удалите соответствующую строку из `Schedule` или измените `status` на любое значение, отличное от `blocked` (например, оставьте пустым или `open`). После этого слот снова будет считаться доступным.

Важные нюансы:

- Времена и даты интерпретируются в таймзоне салона (см. `Settings.timezone` или `DEFAULT_TIMEZONE` в `.env`). Убедитесь, что задаёте время в правильной таймзоне.
- Изменения в листе вступают в силу почти сразу, но система использует кэш дней с TTL ≈ 60 секунд — возможно небольшая задержка (до ~1 минуты).
- Для блокировки нескольких промежутков подряд добавляйте отдельные строки для каждого интервала.
- Не используйте пересекающиеся блокировки с существующими записями без предварительной договорённости с клиентами — это не отменяет уже подтверждённые записи автоматически.

Если нужна помощь — напишите разработчику, и он подскажет формат или внесёт массовые блокировки.

## Таймзона салона

- Таймзона хранится в листе `Settings` ключом `timezone`. Если там нет значения, используется `DEFAULT_TIMEZONE` из `.env`.
- Для корректных напоминаний и отображения дат/времён убедитесь, что `timezone` задана корректно (например: `Europe/Moscow`, `Asia/Yekaterinburg`).

## Если уведомления не приходят

- Проверьте, что в `.env` задан `MANAGER_CHAT_ID`.
- Убедитесь, что бот запущен (`node index.js` или через process manager) и что бот не заблокирован вашим аккаунтом.
- Проверьте логи бота на предмет ошибок (доступ к логам есть у разработчика/администратора сервера).

## Перезапуск бота (Windows / PowerShell)

```powershell
# простой запуск
node index.js

# если используете pm2 (рекомендовано для продакшена):
pm2 restart barber-bot
pm2 start index.js --name barber-bot
```

## Безопасность

- Не публикуйте `GOOGLE_PRIVATE_KEY`, `BOT_TOKEN` и `.env` в публичные репозитории.

## Контакты и поддержка

- Если нужно добавить/изменить рабочие часы, слоты услуг или автоматические сообщения — обратитесь к разработчику проекта.
- Для срочных изменений (например, отмена большого количества записей) — можно править Google Sheets напрямую, соблюдая формат колонок.

---

Если хотите, я могу добавить в репозиторий `MANAGER.md` как отдельный пункт в `README` или создать `.env.example` с шаблоном переменных.
