# Инструкция для менеджера

Этот файл — краткая инструкция для менеджера салона по работе с ботом и таблицей Google Sheets.

## Кому полезно

- Менеджеру, который хочет просматривать записи, блокировать время и получать уведомления о новых/отменённых записях.

## Привязка к Google Таблицам и Google Календарю + скачивание credentials.json

Ниже описана настройка доступа бота к Google Sheets и Google Calendar через сервисный аккаунт Google. В результате вы получите файл credentials.json (для хранения локально) и заполните переменные в .env.

Важное:

- В рантайме проект использует переменные окружения GOOGLE_CLIENT_EMAIL и GOOGLE_PRIVATE_KEY, а не файл credentials.json напрямую. JSON можно хранить локально как источник данных для этих переменных.
- Никогда не коммитьте credentials.json и .env в публичный репозиторий.

Шаг 1 — Создайте проект в Google Cloud Console

1. Откройте https://console.cloud.google.com (войдите под вашим Google‑аккаунтом).
2. В верхней панели нажмите Select project → New Project, задайте имя (например, Barber Bot) и создайте проект.

Шаг 2 — Включите API

1. Откройте меню APIs & Services → Library.
2. Найдите и включите:
   - Google Sheets API
   - Google Calendar API

Шаг 3 — Создайте сервисный аккаунт

1. Перейдите в IAM & Admin → Service Accounts → Create Service Account.
2. Задайте имя (например, barber-bot) и создайте.
3. Роль на шаге Assign roles можно пропустить либо выбрать Editor (необязательно для доступа к конкретным ресурсам, т.к. доступ будет дан через «Поделиться» в Sheets/Calendar).
4. После создания откройте созданный аккаунт → Keys → Add key → Create new key → JSON. Скачается файл credentials.json.

Что важно из credentials.json:

- client_email — адрес сервисного аккаунта вида something@project-id.iam.gserviceaccount.com
- private_key — приватный ключ (многострочный блок между BEGIN/END PRIVATE KEY)

Шаг 4 — Поделитесь доступом к Google Sheet с сервисным аккаунтом

1. Откройте вашу таблицу Google Sheets, где будут храниться данные.
2. Нажмите Share и добавьте client_email из credentials.json как Editor (Редактор).
3. Сохраните.

Как получить ID таблицы (GOOGLE_SHEETS_ID):

- Откройте таблицу в браузере. В URL часть между /d/ и /edit — это ID.
  Пример: https://docs.google.com/spreadsheets/d/1AbCdEfGhIjKlMnOpqR/edit → ID = 1AbCdEfGhIjKlMnOpqR

Шаг 5 — Дайте сервисному аккаунту доступ к календарю

1. Откройте Google Calendar (в браузере) под владельцем нужного календаря.
2. Слева выберите нужный календарь → «Настройки и доступ» → «Открыть доступ для конкретных пользователей» → «Добавить пользователей».
3. Впишите client_email и назначьте право «Вносить изменения в события» (Make changes to events).

Как получить ID календаря (GOOGLE_CALENDAR_ID):

- Для вторичных календарей ID отображается в настройках календаря (раздел «Интегрировать календарь»), обычно вида your-calendar-id@group.calendar.google.com.
- Для основного календаря аккаунта Google можно использовать email владельца (например, your.name@gmail.com).

Шаг 6 — Заполните .env в корне проекта
Создайте/откройте файл .env и заполните значения:

BOT*TOKEN=ваш*токен*бота
GOOGLE_SHEETS_ID=скопированный_id*таблицы
GOOGLE*CLIENT_EMAIL=client_email*из*credentials.json
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
GOOGLE_CALENDAR_ID=идентификатор*календаря # опционально, для синхронизации с календарём
DEFAULT_TIMEZONE=Asia/Yekaterinburg # опционально
MANAGER_CHAT_ID=123456789 # опционально, уведомления менеджера

Подсказки по GOOGLE_PRIVATE_KEY:

- Ключ многострочный. В .env его нужно записать одной строкой, заменив переводы строк на символы \n.
- Код автоматически преобразует \n в реальные переводы строк при запуске.

Шаг 7 — Проверка работы

1. Установите зависимости и запустите бота:
   npm install
   npm start
2. На первом запуске сервис создаст недостающие листы и заголовки в таблице. Если прав недостаточно, в логах будет ошибка «insufficient permissions» — проверьте, что вы расшарили таблицу сервисному аккаунту как Editor.
3. Для календаря: при создании новых записей должны появляться события в указанном календаре. Если нет — проверьте GOOGLE_CALENDAR_ID и доступ «Вносить изменения в события» для client_email.

Устранение неполадок

- PERMISSION_DENIED при обращении к таблице/календарю: проверьте, что именно client_email из credentials.json добавлен в доступы и роль — Editor (таблица) / Make changes to events (календарь).
- invalid_grant/unauthorized_client: убедитесь, что включены нужные API в Google Cloud (Sheets/Calendar) и что время на сервере синхронизировано (NTP).
- malformed private key: проверьте кавычки и экранирование \n в GOOGLE_PRIVATE_KEY в .env.
- События не создаются, но записи в таблице есть: проверьте наличие GOOGLE_CALENDAR_ID. Без него календарная интеграция отключена, это не ошибка.

Примечание о credentials.json

- Файл можно хранить только локально для справки. В репозиторий не добавлять. Для продакшена используйте исключительно переменные окружения.

## Включение менеджерских уведомлений

1. В `.env` (или в переменных окружения на сервере) задайте `MANAGER_CHAT_ID` равным вашему Telegram chat id.
2. Если `MANAGER_CHAT_ID` не задан, уведомления менеджера не отправляются.

Как получить свой Chat ID (простые варианты):

- В Telegram найдите бота `@userinfobot` или `@getidsbot`, нажмите Start — бот покажет ваш id.
- Либо попросите разработчика временно включить логирование `ctx.from.id` при вашем сообщении в бота.

После установки `MANAGER_CHAT_ID` и перезапуска бота вы будете получать уведомления о новых записи и об отменах.

## Просмотр записей

- Откройте Google Sheets, указанный в `GOOGLE_SHEETS_ID`.
- Лист `Записи` содержит все записи. Отфильтруйте по столбцу `Статус` = `активна` и дате.
- Полезные столбцы: `ID_записи`, `Услуга`, `Дата`, `Время_начала`, `Время_окончания`, `Имя_клиента`, `Телефон`, `Username_Telegram`, `Комментарий`, `Код_отмены`.

## Бан пользователей

- Для бана используйте функцию в админ‑меню «Забанить пользователя». В таблице на листе `Клиенты` будет установлен `BanStatus = banned`, а в `BanReason` — причина (если указали).
- Разбан: функция «Разбанить пользователя» снимет бан в таблице (`BanStatus` очистится) и из локального списка `banned.json`.
- Забанированные пользователи:
  - не могут начать сцену записи (бот сообщит о блокировке и завершит сцену);
  - не могут создать запись (сервис бронирования вернёт ошибку `reason: banned`);
  - исключаются из рассылок при включённой опции `skipBanned`.

## Работа в боте — админ‑режим

- Откройте диалог с ботом и выполните команду `/admin`. Команда активна только для аккаунта, чей `id` совпадает с `MANAGER_CHAT_ID`.
- В админ‑режиме бот показывает reply‑клавиатуру с пунктами:
  - `Просмотр записей` — показать активные записи (первые 50 строк);
  - `Статистика` — краткая статистика: количество активных записей и число клиентов в базе;
  - `Отменить запись (по ID)` — введите ID записи для отмены (после ввода бот подтвердит и, при наличии `telegram_id` клиента, уведомит его);
  - `Забанить пользователя` — введите Telegram ID или `@username`; если найден по username, будет использован `telegram_id` из таблицы `Clients`;
  - `Разбанить пользователя` — введите Telegram ID для снятия блокировки;
  - `Массовая рассылка` — введите текст рассылки, получите предпросмотр (количество получателей и примеры), затем подтвердите или отмените отправку.
  - `Вернуться в пользовательский режим` — переключиться обратно на обычную клавиатуру клиента.

Примечание: все текстовые операции (ввод ID, текста рассылки и т.п.) ожидают ввода после выбора соответствующего пункта клавиатуры; отмена текущего админ‑действия — команда `/admin_cancel`.

# Руководство менеджера: массовая рассылка (текст и картинки)

## Возможности рассылки

- Текстовая рассылка (обычные сообщения).
- Рассылка изображения (одно фото) с подписью.
- Фильтрация получателей по бан-листу (забаненные не получают сообщения).
- Предпросмотр перед отправкой и явное подтверждение.
- Троттлинг отправок (по умолчанию 200 мс между сообщениями), чтобы снизить риск ограничения со стороны Telegram.

## Как отправить текстовую рассылку

1. Перейдите в режим администратора командой /admin.
2. Нажмите кнопку «Массовая рассылка».
3. Отправьте текст рассылки одним сообщением.
4. Бот посчитает количество получателей, покажет предпросмотр и предложит подтвердить или отменить отправку.
5. Нажмите «Подтвердить рассылку ✅» для старта или «Отменить ❌» для отмены.

После завершения бот вернёт статистику: сколько отправлено успешно и сколько с ошибками.

## Как отправить рассылку с картинкой

1. Перейдите в режим администратора командой /admin.
2. Нажмите кнопку «Массовая рассылка».
3. Отправьте фото как сообщение с вложением. Можно добавить подпись к фото (это будет caption).
4. Бот посчитает количество получателей, покажет предпросмотр (отдельно отправит фото и подпись), предложит подтвердить или отменить.
5. Нажмите «Подтвердить рассылку ✅» либо «Отменить ❌».

Важно:

- Берётся последнее (самое большое) превью из массива фотографий, предоставляемого Telegram (file_id), и оно же используется для отправки.
- Отправляется одно фото на сообщение (альбомы/несколько фото одним месседжем не поддерживаются).

## Ограничения и примечания

- Получатели формируются из базы клиентов (sheetsService.getAllClients), у которых есть telegramId, за вычетом бан-листа (banned.json).
- Бан/разбан доступен в админ-меню и влияет на рассылку.
- При большом списке рассылка может занять время из-за троттлинга (200 мс между сообщениями). Это значение можно менять в коде при вызове adminService.broadcastToClients.
- Для фото используется sendPhoto(fileId, { caption }). Для текста — sendMessage(text).

## Изменения в коде (коротко)

- src/services/admin.js: функция broadcastToClients теперь принимает универсальный payload:

  - Строка (старый режим) — отправляется как текст.
  - Объект с формой { kind: "text", text } — текстовая рассылка.
  - Объект с формой { kind: "photo", fileId, caption } — фото-рассылка с подписью.
  - Опции { recipients, throttleMs, skipBanned } сохранены и совместимы.

- src/bot/index.js:
  - Подсказка в разделе «Массовая рассылка» расширена: можно прислать текст или фото с подписью.
  - Добавлен обработчик bot.on("photo") в режиме администратора, который строит payload для фото, показывает предпросмотр и просит подтверждение.
  - Обработчик подтверждения использует универсальный payload (текст или фото).

## Типичные сценарии

- Срочная промо-акция: отправьте картинку с акцией и подписью — клиенты получат наглядное сообщение.
- Информирование об изменениях расписания/цен: отправьте текст без фото.

## Что проверить, если «не отправляется»

- Убедитесь, что вы в режиме администратора (/admin) и Telegram ID менеджера совпадает с config.managerChatId.
- Проверьте, что у клиентов есть telegramId в таблице и они не забанены.
- Посмотрите логи/сообщение об ошибках в ответе бота после рассылки: он показывает количество ошибок.
- При лимитах Telegram попробуйте увеличить задержку (throttle) в коде.

## Команды и кнопки администратора

- /admin — включить режим администратора.
- /user — вернуться в пользовательский режим.
- «Массовая рассылка» — вход в режим ожидания текста или фото.
- «Подтвердить рассылку ✅» — старт отправки.

## Безопасность и ограничения

### Ограничения массовых рассылок

- Максимальное количество получателей: **1000**
- Если количество получателей превышает лимит, рассылка будет отклонена
- Все рассылки требуют подтверждения перед отправкой
- Все массовые рассылки логируются в `logs/security.log`

### Rate Limiting

Бот защищён от злоупотребления через ограничение частоты запросов:

- Админ-команды: максимум 10 запросов в минуту
- При превышении лимита пользователь получит сообщение "Слишком много запросов. Пожалуйста, подождите немного."

### Резервное копирование

- Автоматические бэкапы создаются раз в день
- Дополнительные бэкапы создаются при критичных операциях (бан/разбан пользователя, массовая рассылка)
- Бэкапы хранятся в директории `backups/` и автоматически удаляются через 30 дней
- Бэкапируются файлы: `sessions.json`, `banned.json`, `services.json`

### Логирование

Все критичные действия администратора логируются:

- Включение/выключение админ-режима
- Бан/разбан пользователей
- Отмена записей администратором
- Массовые рассылки
- Управление услугами

Логи доступны в файле `logs/security.log` и помогают отслеживать все административные действия.

- «Отменить ❌» или /admin_cancel — отмена текущего действия администратора.

## Отмена записи вручную

1. В `Записи` найдите строку с `ID_записи` нужной записи.
2. В колонке `Статус` установите `отменена`.
3. В колонке `Отменено_UTC` впишите текущее время в формате ISO (например: `2025-12-23T10:30:00Z`).
4. (Опционально) отправьте клиенту сообщение вручную, если нужно; бот отправит уведомление, только если отмену сделает клиент через интерфейс.

> Примечание: корректная ручная отмена нужна, чтобы система не предлагала занятые слоты и чтобы отчёты были точными.

## Статусы записей

- `активна` — запись активна, клиент ожидает услугу
- `отменена` — запись отменена клиентом или администратором
- `исполнено` — услуга оказана, запись автоматически завершена
- `заблокировано` — время заблокировано для записи

## Автоматическое завершение записей

Система автоматически обновляет статус записей на "исполнено" сразу после окончания времени услуги. Проверка происходит каждые 30 минут.

**Новая колонка в листе "Записи":**

- `Исполнено_UTC` — дата и время отметки об исполнении (формат ISO UTC)

## Блокировка слотов (закрыть время для записи)

Блокировка производится через лист `Расписание`. Ниже — подробные правила формата и примеры.

**Формат строки (колонки в таблице):** `Дата | Время_начала | Время_окончания | Статус | Услуга | Примечание`

- `Дата` — дата в формате `YYYY-MM-DD` (пример: `2025-12-24`).
- `Время_начала` / `Время_окончания` — время в 24‑часовом формате `HH:MM` (пример: `13:00`, `09:30`). Часы и минуты должны быть с ведущими нулями.
- `Статус` — значение `заблокировано` (строго). Только строки со `Статус = заблокировано` учитываются как блокировка.
- `Услуга` — опционально; можно оставить пустым или указать причину/услугу (например, `ВСЕ` или `ВЫХОД`).
- `Примечание` — короткое пояснение для менеджеров (например, `перерыв`, `праздник`, `ремонт`).

**Практические примеры** (вставлять начиная со строки 2, под заголовком):

- Блокировка обеда 24 декабря с 13:00 до 14:00:
  - `2025-12-24 | 13:00 | 14:00 | заблокировано | | перерыв на обед`
- Блокировка всего дня (закрыть запись на весь день):
  - `2025-12-31 | 00:00 | 23:59 | заблокировано | | закрыто на Новый год`

**Как отменить блокировку:**

- Удалите соответствующую строку из `Расписание` или измените `Статус` на любое значение, отличное от `заблокировано` (например, оставьте пустым или `открыто`). После этого слот снова будет считаться доступным.

**Важные нюансы:**

- Времена и даты интерпретируются в таймзоне салона (см. `Настройки.таймзона` или `DEFAULT_TIMEZONE` в `.env`). Убедитесь, что задаёте время в правильной таймзоне.
- Изменения в листе вступают в силу почти сразу, но система использует кэш дней с TTL ≈ 60 секунд — возможна небольшая задержка (до ~1 минуты).
- Для блокировки нескольких промежутков подряд добавляйте отдельные строки для каждого интервала.
- Не используйте пересекающиеся блокировки с существующими записями без предварительной договорённости с клиентами — это не отменяет уже подтверждённые записи автоматически.

Если нужна помощь — напишите разработчику, и он подскажет формат или внесёт массовые блокировки.

## Таймзона салона

- Таймзона хранится в листе `Настройки` ключом `таймзона`. Если там нет значения, используется `DEFAULT_TIMEZONE` из `.env`.
- Для корректных напоминаний и отображения дат/времён убедитесь, что `таймзона` задана корректно (например: `Europe/Moscow`, `Asia/Yekaterinburg`).

## Структура Google Sheets

- `Настройки` — ключ/значение (колонки: `Ключ`, `Значение`)
- `Расписание` — ко��онки: `Дата`, `Время_начала`, `Время_окончания`, `Статус`, `Услуга`, `Примечание`
- `Записи` — колонки: `ID_записи`, `Создано_UTC`, `Услуга`, `Дата`, `Время_начала`, `Время_окончания`, `Имя_клиента`, `Телефон`, `Username_Telegram`, `Комментарий`, `Статус`, `Код_отмены`, `Telegram_ID`, `Chat_ID`, `Отменено_UTC`, `Исполнено_UTC`
- `Клиенты` — колонки: `ID_клиента`, `Первое_посещение_UTC`, `Telegram_ID`, `Username_Telegram`, `Имя`, `Телефон`, `Последняя_запись_UTC`, `Всего_записей`, `BanStatus`, `BanReason`, `Напоминание_21день_UTC`

## Рабочие часы (лист `WorkHours`)

Новый лист `WorkHours` позволяет задать часы работы по дням недели и/или отдельные исключения по конкретным датам.

Колонки (заголовок должен быть в первой строке):

- `Дата` — опционально, конкретная дата в формате `YYYY-MM-DD`. Если заполнено, имеет приоритет над `День_недели`.
- `День_недели` — опционально, короткое обозначение дня недели (например: `mon`, `tue`, `wed` или русское `пн`, `вт` и т.п.). Используется, когда `Дата` не заполнена.
- `Время_начала` — в формате `HH:MM` (например, `09:00`).
- `Время_окончания` — в формате `HH:MM` (например, `18:00`).
- `Обед_начало` — опционально, начало обеда в формате `HH:MM` (например, `13:00`).
- `Обед_окончание` — опционально, конец обеда в формате `HH:MM` (например, `14:00`).

Правило приоритетов:

- Если для конкретной `Дата` задана запись — она имеет приоритет и применяется в первую очередь.
- Если для даты нет записи, используется строка по `День_недели`.
- Если нет ни той, ни другой записи — считается, что день закрыт для записи.

Примеры (вставлять со строки 2):

- Рабочие часы по понедельникам: ` | mon | 10:00 | 20:00`
- Специальные часы на 2025-05-01: `2025-05-01 |  | 12:00 | 16:00`
- Рабочие часы по понедельникам с обедом: ` | mon | 10:00 | 20:00 | 13:00 | 14:00`
- Специальные часы на 2025-05-01 с обедом: `2025-05-01 |  | 12:00 | 16:00 | 13:00 | 14:00`

Примечание:

- Менеджер может редактировать этот лист напрямую в Google Sheets; изменения применяются почти моментально (с учётом кэша ≈ 2 минуты).
- Формат времени должен быть корректным `HH:MM`. Некорректные строки будут игнорироваться и день может считаться закрытым.

## Если уведомления не приходят

- Проверьте, что в `.env` задан `MANAGER_CHAT_ID`.
- Убедитесь, что бот запущен (`node index.js` или через process manager) и что бот не заблокирован вашим аккаунтом.
- Проверьте логи бота на предмет ошибок (доступ к логам есть у разработчика/администратора сервера).

## Перезапуск бота (Windows / PowerShell)

```powershell
# простой запуск
node index.js

# если используете pm2 (рекомендовано для продакшена):
pm2 restart barber-bot
pm2 start index.js --name barber-bot
```

## Управление услугами

Администратор может управлять услугами через кнопку **«Управление услугами»** в админ-меню.

### Доступные действия

- **Добавить услугу** — создание новой услуги с указанием названия, цены и продолжительности
- **Изменить услугу** — редактирование существующей услуги (название, цена, продолжительность)
- **Удалить услугу** — удаление услуги с подтверждением
- **Список услуг** — просмотр всех услуг с ценами и продолжительностью

### Структура услуги

| Поле              | Описание                                                   |
| ----------------- | ---------------------------------------------------------- |
| Ключ              | Уникальный идентификатор (латинские буквы и подчёркивания) |
| Название          | Отображаемое название услуги                               |
| Цена              | Стоимость в рублях (может быть пустой)                     |
| Продолжительность | Время в минутах (обязательно)                              |

### Отображение цен

Цены услуг показываются пользователям:

- В списке услуг (`/services`)
- При выборе услуги в сцене записи

### Файл хранения

Услуги хранятся в файле `services.json` в корне проекта. При первом запуске после обновления существующие услуги мигрируются из кода в этот файл автоматически.

### Валидация

- Ключ услуги должен быть уникальным
- Название не может быть пустым
- Цена должна быть числом >= 0 (опционально)
- Продолжительность должна быть числом > 0

## Напоминание для неактивных клиентов

Система автоматически отправляет напоминания клиентам, которые не посещали салон более 21 дня.

### Как это работает

- Проверка выполняется ежедневно в 11:00 по таймзоне салона
- Бот анализирует всех клиентов и находит тех, у кого:
  - Последняя завершённая запись была более 21 дня назад
  - Нет активных (неотменённых) записей
  - Есть telegramId для отправки сообщения
  - Клиент не забанен
  - Напоминание ещё не отправлялось (поле `Напоминание_21день_UTC` пустое)

### Что отправляется клиенту

- Дружелюбное сообщение с напоминанием о том, что прошло время с последней стрижки
- Призыв записаться на новую стрижку
- Напоминание отправляется только один раз

### Сброс напоминания при новой записи

Когда клиент записывается на новую услугу, поле `Напоминание_21день_UTC` автоматически очищается. Это позволяет клиенту снова получить напоминание через 21 день после новой записи.

### Поле в таблице

В листе `Клиенты` добавлена новая колонка:

- `Напоминание_21день_UTC` — дата и время отправки напоминания (ISO UTC). Пустое значение означает, что напоминание ещё не отправлялось.

### Отчёт менеджеру

После выполнения проверки бот отправляет менеджеру отчёт:

- Список клиентов, получивших напоминание
- Количество успешных отправок
- Количество ошибок (например, если клиент заблокировал бота)
