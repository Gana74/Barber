# Инструкция для мастера по работе с ботом

Добро пожаловать! Эта инструкция поможет вам эффективно использовать Telegram-бот для управления записями.

## Содержание

1. [Введение и начало работы](#введение-и-начало-работы)
2. [Основные функции админ-панели](#основные-функции-админ-панели)
3. [Работа с Google Sheets](#работа-с-google-sheets)
4. [Практические сценарии](#практические-сценарии)
5. [Автоматические функции](#автоматические-функции)
6. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)
7. [Безопасность и ограничения](#безопасность-и-ограничения)

---

## Введение и начало работы

### Что такое бот и для чего он нужен

Telegram-бот — это автоматизированная система для приёма записей клиентов. Бот позволяет:

- Клиентам самостоятельно записываться на услуги
- Вам управлять записями, просматривать статистику
- Отправлять массовые уведомления клиентам
- Управлять услугами и ценами
- Блокировать нежелательных клиентов

### Как получить доступ к админ-режиму

Админ-режим доступен только мастеру/менеджеру салона. Ваш Telegram ID должен быть настроен в системе администратором.

**Важно:** Если команда `/admin` не работает, обратитесь к администратору для настройки доступа.

### Первые шаги: команда `/admin`

1. Откройте диалог с ботом в Telegram
2. Отправьте команду `/admin`
3. Бот покажет админ-клавиатуру с доступными функциями

**Пример диалога:**

```
Вы: /admin

Бот: Включён режим администратора. Выберите действие:

[Просмотр записей] [Статистика]
[Отменить запись (по коду)]
[Забанить пользователя] [Разбанить пользователя]
[Массовая рассылка]
[Управление услугами]
[Вернуться в пользовательский режим]
```

**Примечание:** Чтобы вернуться в обычный режим (как у клиентов), используйте команду `/user` или кнопку "Вернуться в пользовательский режим".

---

## Основные функции админ-панели

### Просмотр записей

Позволяет увидеть все активные (неотменённые) записи.

**Как использовать:**

1. Нажмите кнопку **"Просмотр записей"**
2. Бот покажет список активных записей (первые 50) с кодами отмены

**Пример вывода:**

```
Активные записи (показано 5 из 8):

Код отмены: A3K9X2 — Мужская стрижка 15.01.2025 14:00-15:00 — Иван Петров (+79991234567)
Код отмены: B7M2N5 — Оформление бороды 15.01.2025 16:00-16:30 — Сергей Сидоров (+79997654321)
Код отмены: C8P4Q6 — Мужская стрижка 16.01.2025 10:00-11:00 — Алексей Иванов (+79991112233)
Код отмены: D9R5S7 — Стрижка под машинку 16.01.2025 12:00-12:30 — Дмитрий Козлов (+79994445566)
Код отмены: E0T6U8 — Мужская стрижка 17.01.2025 15:00-16:00 — Максим Смирнов (+79997778899)
```

**Формат записи:**

- `ID` — уникальный номер записи
- `Услуга` — название услуги
- `Дата` — дата в формате ДД.ММ.ГГГГ
- `Время` — время начала и окончания
- `Имя клиента` — имя из профиля или введённое при записи
- `Телефон` — номер телефона

**Важно:** Если записей больше 50, бот покажет только первые 50. Для просмотра всех записей используйте Google Sheets (см. раздел "Работа с Google Sheets").

---

### Статистика

Показывает краткую информацию о текущем состоянии системы.

**Как использовать:**

1. Нажмите кнопку **"Статистика"**
2. Бот покажет количество активных записей и клиентов

**Пример вывода:**

```
Статистика:
Активных записей: 8
Клиентов в базе: 45
```

**Что означают цифры:**

- **Активных записей** — количество записей со статусом "активна" (клиент записан и ждёт услугу)
- **Клиентов в базе** — количество уникальных клиентов, которые когда-либо записывались через бота

---

### Отмена записей

Через админ-панель способ отменить запись: по коду отмены.

**Важно:**

- После отмены клиент получит уведомление в Telegram (если он не заблокировал бота)
- Запись автоматически удалится из Google Calendar (если настроена интеграция)
- Отменённую запись нельзя восстановить через бота (нужно будет создать новую)

#### Отмена по коду отмены

**Когда использовать:** Когда клиент сообщил вам что не придет или непришел и не отменил запись. Код отмены — это 6-символьный код, который генерируется при создании записи.(его можно увидеть в оповещении о новых записях или в меню "просмотр записи")

**Формат кода:** 6 символов (буквы и цифры), например: `A3K9X2`, `B7M2N5`

**Как использовать:**

1. Нажмите кнопку **"Отменить запись (по коду)"**
2. Бот попросит ввести код отмены
3. Отправьте код (например: `A3K9X2`)
4. Бот найдёт запись по коду и отменит её

**Пример диалога:**

```
Вы: Отменить запись (по коду)

Бот: Отправьте код отмены записи (например: A3K9X2).
     Для отмены напишите /admin_cancel

Вы: A3K9X2

Бот: Запись отменена по коду A3K9X2.
     ID: 12345
     Клиент: Иван Петров
     Дата: 15.01.2025 14:00
```

**Где найти код отмены:**

- В боте через кнопку "Просмотр записей" — код отмены отображается в каждой строке записи
- В Google Sheets в листе "Записи" в колонке "Код_отмены"
- В уведомлении менеджеру при создании новой записи (строка "Код отмены: ...")


**Важно:**

- Код чувствителен к регистру, но бот автоматически преобразует его в верхний регистр
- Если запись уже отменена, бот сообщит об этом
- Если код не найден, бот сообщит об ошибке

---

### Бан и разбан пользователей

Позволяет заблокировать доступ к боту для проблемных клиентов или разблокировать ранее забаненных.

#### Забанить пользователя

**Когда использовать:**

- Клиент нарушает правила (спам, оскорбления)
- Клиент постоянно не приходит на записи
- Другие причины, требующие блокировки

**Как использовать:**

1. Нажмите кнопку **"Забанить пользователя"**
2. Бот попросит ввести Telegram ID или @username
3. Отправьте ID (например: `123456789`) или username (например: `@username`)
4. Бот заблокирует пользователя

**Пример диалога (по ID):**

```
Вы: Забанить пользователя

Бот: Отправьте Telegram ID или @username пользователя для бана.
     Для отмены напишите /admin_cancel

Вы: 123456789

Бот: Пользователь 123456789 забанен.
```

**Пример диалога (по username):**

```
Вы: Забанить пользователя

Бот: Отправьте Telegram ID или @username пользователя для бана.
     Для отмены напишите /admin_cancel

Вы: @problem_client

Бот: Пользователь 123456789 забанен.
```

**Что происходит после бана:**

- Пользователь не может начать процесс записи (бот сообщит о блокировке)
- Пользователь не может создать новую запись
- Пользователь исключается из массовых рассылок
- В Google Sheets в листе "Клиенты" устанавливается `BanStatus = banned`

**Как узнать Telegram ID клиента:**

- В Google Sheets в листе "Клиенты" в колонке "Telegram_ID"
- В листе "Записи" в колонке "Telegram_ID"

#### Разбанить пользователя

**Когда использовать:** Когда нужно снять блокировку с ранее забаненного клиента.

**Как использовать:**

1. Нажмите кнопку **"Разбанить пользователя"**
2. Бот попросит ввести Telegram ID
3. Отправьте ID (например: `123456789`)
4. Бот разблокирует пользователя

**Пример диалога:**

```
Вы: Разбанить пользователя

Бот: Отправьте Telegram ID пользователя для разбанивания.
     Для отмены напишите /admin_cancel

Вы: 123456789

Бот: Пользователь 123456789 разбанен.
```

**Важно:** Для разбана нужен именно Telegram ID, username не подойдёт.

---

### Массовая рассылка

Позволяет отправить сообщение всем клиентам одновременно. Можно отправить текст или фото с подписью.

**Ограничения:**

- Максимум 1000 получателей за одну рассылку
- Рассылка требует подтверждения перед отправкой
- Забаненные клиенты автоматически исключаются

#### Текстовая рассылка

**Как использовать:**

1. Нажмите кнопку **"Массовая рассылка"**
2. Бот попросит отправить текст или фото
3. Отправьте текст сообщения
4. Бот покажет предпросмотр с количеством получателей
5. Нажмите **"Подтвердить рассылку ✅"** или **"Отменить ❌"**

**Пример диалога:**

```
Вы: Массовая рассылка

Бот: Отправьте текст для рассылки или пришлите фото с подписью.
     Для отмены напишите /admin_cancel

Вы: Дорогие клиенты! Напоминаем, что завтра праздничный день,
    салон работает с 12:00 до 18:00. Благодарим за понимание!

Бот: Предпросмотр рассылки:

     Текст:
     Дорогие клиенты! Напоминаем, что завтра праздничный день,
     салон работает с 12:00 до 18:00. Благодарим за понимание!

     Получателей: 45
     Примеры: 123456789, 987654321, 111222333, 444555666, 777888999, 101112131

     [Подтвердить рассылку ✅]
     [Отменить ❌]

Вы: [Нажимаете "Подтвердить рассылку ✅"]

Бот: Запускаю рассылку на 45 клиентов...
     Рассылка завершена. Отправлено: 43. Ошибок: 2.
```

**Что означают ошибки:**

- Ошибки могут возникнуть, если клиент заблокировал бота
- Ошибки могут возникнуть, если клиент удалил аккаунт
- Бот показывает общее количество успешных отправок и ошибок

#### Рассылка с фото

**Как использовать:**

1. Нажмите кнопку **"Массовая рассылка"**
2. Бот попросит отправить текст или фото
3. Отправьте фото (можно добавить подпись к фото)
4. Бот покажет предпросмотр фото и подписи
5. Нажмите **"Подтвердить рассылку ✅"** или **"Отменить ❌"**

**Пример диалога:**

```
Вы: Массовая рассылка

Бот: Отправьте текст для рассылки или пришлите фото с подписью.
     Для отмены напишите /admin_cancel

Вы: [Отправляете фото с подписью "Новая акция! Скидка 20% на все услуги до конца месяца"]

Бот: Предпросмотр фото-письма. Подпись:
     Новая акция! Скидка 20% на все услуги до конца месяца

     [Бот отправляет фото]

     Получателей: 45
     Примеры: 123456789, 987654321, 111222333, 444555666, 777888999, 101112131

     [Подтвердить рассылку ✅]
     [Отменить ❌]

Вы: [Нажимаете "Подтвердить рассылку ✅"]

Бот: Запускаю рассылку на 45 клиентов...
     Рассылка завершена. Отправлено: 44. Ошибок: 1.
```

**Важно:**

- Можно отправить фото без подписи (просто отправьте фото)
- Отправляется одно фото на сообщение (несколько фото одновременно не поддерживается)
- Бот использует самое большое доступное превью фото

**Совет:** Для больших рассылок процесс может занять время (примерно 200 мс на каждого получателя). Не закрывайте диалог с ботом во время рассылки.

---

### Управление услугами

Позволяет добавлять, изменять, удалять услуги и просматривать их список.

#### Просмотр списка услуг

**Как использовать:**

1. Нажмите кнопку **"Управление услугами"**
2. Нажмите **"Список услуг"**
3. Бот покажет все услуги с ценами и продолжительностью

**Пример вывода:**

```
Список услуг:

• Мужская стрижка
  Ключ: MEN_HAIRCUT
  Цена: 1500 ₽
  Продолжительность: 60 мин

• Оформление бороды
  Ключ: BEARD
  Цена: 800 ₽
  Продолжительность: 30 мин

• Стрижка под машинку
  Ключ: BUZZCUT
  Цена: 600 ₽
  Продолжительность: 30 мин

• Женская стрижка
  Ключ: WOMEN_HAIRCUT
  Цена: 2000 ₽
  Продолжительность: 60 мин
```

**Что означают поля:**

- **Ключ** — технический идентификатор услуги (используется системой)
- **Цена** — стоимость услуги в рублях (может быть не указана)
- **Продолжительность** — время выполнения услуги в минутах

#### Добавление новой услуги

**Как использовать:**

1. Нажмите кнопку **"Управление услугами"**
2. Нажмите **"Добавить услугу"**
3. Бот попросит ввести ключ услуги
4. Отправьте ключ (например: `NEW_SERVICE`)
5. Бот попросит ввести название
6. Отправьте название (например: `Детская стрижка`)
7. Бот попросит ввести цену
8. Отправьте цену в рублях (например: `1000`) или `нет` если цена не указана
9. Бот попросит ввести продолжительность
10. Отправьте продолжительность в минутах (например: `45`)

**Пример диалога:**

```
Вы: Добавить услугу

Бот: Добавление новой услуги.

     Отправьте ключ услуги (латинские буквы, цифры, подчёркивания,
     например: NEW_SERVICE):
     Для отмены напишите /admin_cancel

Вы: CHILD_HAIRCUT

Бот: Отправьте название услуги:

Вы: Детская стрижка

Бот: Отправьте цену услуги (число в рублях) или 'нет' если цена не указана:

Вы: 1000

Бот: Отправьте продолжительность услуги в минутах:

Вы: 45

Бот: Услуга "Детская стрижка" успешно создана!
     Ключ: CHILD_HAIRCUT
     Цена: 1000 ₽
     Продолжительность: 45 мин
```

**Правила для ключа:**

- Только латинские буквы (A-Z, a-z)
- Цифры (0-9)
- Подчёркивания (\_)
- Регистр не важен (бот преобразует в верхний)
- Примеры правильных ключей: `NEW_SERVICE`, `child_haircut`, `SERVICE123`

**Важно:**

- Ключ должен быть уникальным (нельзя создать две услуги с одинаковым ключом)
- Если ключ уже существует, бот сообщит об ошибке
- Название не может быть пустым
- Цена должна быть неотрицательным числом (или `нет`)
- Продолжительность должна быть положительным числом

#### Изменение существующей услуги

**Как использовать:**

1. Нажмите кнопку **"Управление услугами"**
2. Нажмите **"Изменить услугу"**
3. Бот покажет список услуг с кнопками
4. Выберите услугу для изменения
5. Бот покажет текущие значения и предложит выбрать поле для изменения
6. Выберите поле (Название, Цена или Продолжительность)
7. Отправьте новое значение

**Пример диалога (изменение цены):**

```
Вы: Изменить услугу

Бот: Выберите услугу для изменения:

     [Мужская стрижка (MEN_HAIRCUT)]
     [Оформление бороды (BEARD)]
     [Стрижка под машинку (BUZZCUT)]
     [Женская стрижка (WOMEN_HAIRCUT)]
     [Отменить]

Вы: [Нажимаете "Мужская стрижка (MEN_HAIRCUT)"]

Бот: Редактирование услуги: Мужская стрижка

     Текущие значения:
     Название: Мужская стрижка
     Цена: 1500 ₽
     Продолжительность: 60 мин

     Выберите поле для изменения:

     [Название]
     [Цена]
     [Продолжительность]
     [Отменить]

Вы: [Нажимаете "Цена"]

Бот: Отправьте новое значение для поля "цену (число или 'удалить' для очистки)":
     Для отмены напишите /admin_cancel

Вы: 1800

Бот: Цена услуги обновлена: 1800 ₽
```

**Особенности изменения:**

- **Название:** Не может быть пустым
- **Цена:**
  - Можно указать новое число (например: `2000`)
  - Можно написать `удалить` или `нет` чтобы убрать цену
  - Должно быть неотрицательным числом
- **Продолжительность:** Должна быть положительным числом

**Пример удаления цены:**

```
Вы: [Выбрали "Цена" для услуги]

Бот: Отправьте новое значение для поля "цену (число или 'удалить' для очистки)":
     Для отмены напишите /admin_cancel

Вы: удалить

Бот: Цена услуги обновлена: не указана
```

#### Удаление услуги

**Как использовать:**

1. Нажмите кнопку **"Управление услугами"**
2. Нажмите **"Удалить услугу"**
3. Бот покажет список услуг с кнопками
4. Выберите услугу для удаления
5. Бот удалит услугу и подтвердит действие

**Пример диалога:**

```
Вы: Удалить услугу

Бот: Выберите услугу для удаления:

     [Мужская стрижка (MEN_HAIRCUT)]
     [Оформление бороды (BEARD)]
     [Стрижка под машинку (BUZZCUT)]
     [Женская стрижка (WOMEN_HAIRCUT)]
     [Отменить]

Вы: [Нажимаете "Стрижка под машинку (BUZZCUT)"]

Бот: Услуга "Стрижка под машинку" удалена.
```

**Важно:**

- Удалённую услугу нельзя восстановить через бота
- Если на удалённую услугу есть активные записи, они останутся в системе, но клиенты не смогут выбрать эту услугу при новой записи
- Рекомендуется сначала отменить все активные записи на эту услугу

---

## Работа с Google Sheets

Все данные бота хранятся в Google Sheets. Вы можете просматривать и редактировать их напрямую в таблице.

### Как открыть таблицу

Таблица находится по адресу, который предоставит администратор. 
```

**Важно:** У вас должен быть доступ к таблице (права редактора или просмотра).

### Структура листов

В таблице есть несколько листов:

#### Лист "Настройки"

Хранит системные настройки в формате ключ-значение.

**Колонки:**

- `Ключ` — название настройки
- `Значение` — значение настройки

**Основные настройки:**

- `таймзона` — часовой пояс салона (например: `Asia/Yekaterinburg`, `Europe/Moscow`)

**Пример:**

| Ключ     | Значение           |
| -------- | ------------------ |
| таймзона | Asia/Yekaterinburg |

**Важно:** Не изменяйте настройки без необходимости. Неправильная таймзона может привести к ошибкам в расписании.

#### Лист "Расписание"

Используется для блокировки времени (закрытие слотов для записи).

**Колонки:**

- `Дата` — дата в формате `YYYY-MM-DD` (например: `2025-01-15`)
- `Время_начала` — начало блока в формате `HH:MM` (например: `13:00`)
- `Время_окончания` — конец блока в формате `HH:MM` (например: `14:00`)
- `Статус` — должен быть `заблокировано` для блокировки
- `Услуга` — опционально, можно оставить пустым
- `Примечание` — опционально, краткое описание (например: `перерыв на обед`)

**Пример блокировки обеда:**

| Дата       | Время_начала | Время_окончания | Статус        | Услуга | Примечание      |
| ---------- | ------------ | --------------- | ------------- | ------ | --------------- |
| 2025-01-15 | 13:00        | 14:00           | заблокировано |        | перерыв на обед |

**Пример блокировки всего дня:**

| Дата       | Время_начала | Время_окончания | Статус        | Услуга | Примечание           |
| ---------- | ------------ | --------------- | ------------- | ------ | -------------------- |
| 2025-01-31 | 00:00        | 23:59           | заблокировано |        | закрыто на Новый год |

**Как отменить блокировку:**

- Удалите строку из таблицы, или
- Измените `Статус` на любое другое значение (например, оставьте пустым)

**Важно:**

- Формат даты строгий: `YYYY-MM-DD` (год-месяц-день)
- Формат времени строгий: `HH:MM` (часы и минуты с ведущими нулями)
- Статус должен быть точно `заблокировано` (регистр важен)
- Изменения применяются почти сразу (с учётом кэша до 1 минуты)

#### Лист "Записи"

Содержит все записи клиентов.

**Колонки:**

- `ID_записи` — уникальный номер записи
- `Создано_UTC` — дата и время создания в UTC
- `Услуга` — название услуги
- `Дата` — дата записи в формате `YYYY-MM-DD`
- `Время_начала` — время начала в формате `HH:MM`
- `Время_окончания` — время окончания в формате `HH:MM`
- `Имя_клиента` — имя клиента
- `Телефон` — номер телефона
- `Username_Telegram` — username в Telegram (если есть)
- `Комментарий` — комментарий клиента (если есть)
- `Статус` — статус записи (`активна`, `отменена`, `исполнено`)
- `Код_отмены` — 6-символьный код для отмены
- `Telegram_ID` — Telegram ID клиента
- `Chat_ID` — ID чата с клиентом
- `Исполнено_UTC` — дата и время отметки об исполнении (если запись завершена)
- `Отменено_UTC` — дата и время отмены (если запись отменена)

**Пример записи:**

| ID_записи | Создано_UTC          | Услуга          | Дата       | Время_начала | Время_окончания | Имя_клиента | Телефон      | Username_Telegram | Комментарий | Статус  | Код_отмены | Telegram_ID | Chat_ID   | Исполнено_UTC | Отменено_UTC |
| --------- | -------------------- | --------------- | ---------- | ------------ | --------------- | ----------- | ------------ | ----------------- | ----------- | ------- | ---------- | ----------- | --------- | ------------- | ------------ |
| 12345     | 2025-01-10T10:30:00Z | Мужская стрижка | 2025-01-15 | 14:00        | 15:00           | Иван Петров | +79991234567 | ivan_petrov       |             | активна | A3K9X2     | 123456789   | 123456789 |               |              |

**Как найти запись:**

1. Откройте лист "Записи"
2. Используйте фильтр по колонке "Статус" (выберите `активна` для активных записей)
3. Используйте поиск (Ctrl+F) по имени клиента, телефону или ID записи

**Статусы записей:**

- `активна` — запись активна, клиент ждёт услугу
- `отменена` — запись отменена клиентом или администратором
- `исполнено` — услуга оказана, запись автоматически завершена

#### Лист "Клиенты"

Содержит информацию о всех клиентах.

**Колонки:**

- `ID_клиента` — уникальный номер клиента
- `Первое_посещение_UTC` — дата первого обращения в UTC
- `Telegram_ID` — Telegram ID клиента
- `Username_Telegram` — username в Telegram (если есть)
- `Имя` — имя клиента
- `Телефон` — номер телефона
- `Последняя_запись_UTC` — дата последней записи в UTC
- `Всего_записей` — общее количество записей клиента
- `BanStatus` — статус бана (`banned` или пусто)
- `BanReason` — причина бана (если есть)
- `Напоминание_21день_UTC` — дата отправки напоминания о неактивности (если было)

**Пример клиента:**

| ID_клиента | Первое_посещение_UTC | Telegram_ID | Username_Telegram | Имя         | Телефон      | Последняя_запись_UTC | Всего_записей | BanStatus | BanReason | Напоминание_21день_UTC |
| ---------- | -------------------- | ----------- | ----------------- | ----------- | ------------ | -------------------- | ------------- | --------- | --------- | ---------------------- |
| 1          | 2025-01-01T12:00:00Z | 123456789   | ivan_petrov       | Иван Петров | +79991234567 | 2025-01-10T10:30:00Z | 3             |           |           |                        |

**Как найти клиента:**

1. Откройте лист "Клиенты"
2. Используйте поиск (Ctrl+F) по имени, телефону, Telegram ID или username

**Важно:**

- Если `BanStatus = banned`, клиент заблокирован и не может записываться
- Если `Напоминание_21день_UTC` заполнено, клиент уже получил напоминание о неактивности

---

## Практические сценарии

### Сценарий 1: Клиент хочет отменить запись

**Ситуация:** Клиент звонит и просит отменить запись.

**Что делать:**

1. Узнайте у клиента:

   - Дату и время записи, или
   - Код отмены (если клиент его знает), или
   - Имя и телефон

2. Найдите запись:

   - В боте: "Просмотр записей" → найдите по имени/телефону → запомните код отмены
   - В Google Sheets: лист "Записи" → найдите по имени/телефону → запомните код отмены из колонки "Код_отмены"

3. Отмените запись:

   - В боте: "Отменить запись (по коду)" → введите код отмены (например: A3K9X2)

4. Подтвердите клиенту, что запись отменена

**Пример:**

```
Клиент: Здравствуйте, я записан на 15 января в 14:00,
        но не смогу прийти. Можно отменить?

Вы: Конечно! Как вас зовут?

Клиент: Иван Петров

Вы: [Открываете бота → "Просмотр записей" → находите запись]
    [Видите: "Код отмены: A3K9X2 — Комплекс 15.01.2025 14:00-15:30 — Иван Петров"]
    [Нажимаете "Отменить запись (по коду)" → вводите: A3K9X2]

Бот: Запись отменена по коду A3K9X2.
     ID: 12345
     Клиент: Иван Петров
     Дата: 15.01.2025 14:00

Вы: Готово! Ваша запись отменена. Можете записаться на другое время.
```

---

### Сценарий 2: Нужно заблокировать время на обед

**Ситуация:** Нужно закрыть время с 13:00 до 14:00 на обед каждый день или на конкретную дату.

**Что делать:**

1. Откройте Google Sheets
2. Перейдите на лист "Расписание"
3. Добавьте новую строку (начиная со строки 2, под заголовком)
4. Заполните колонки:
   - `Дата`: дата в формате `YYYY-MM-DD` (например: `2025-01-15`) или оставьте пустым для ежедневной блокировки
   - `Время_начала`: `13:00`
   - `Время_окончания`: `14:00`
   - `Статус`: `заблокировано`
   - `Услуга`: оставьте пустым
   - `Примечание`: `перерыв на обед`

**Пример для конкретной даты:**

| Дата       | Время_начала | Время_окончания | Статус        | Услуга | Примечание      |
| ---------- | ------------ | --------------- | ------------- | ------ | --------------- |
| 2025-01-15 | 13:00        | 14:00           | заблокировано |        | перерыв на обед |

**Важно:**

- Блокировка применяется почти сразу (с учётом кэша до 1 минуты)
- Клиенты не смогут записаться на заблокированное время
- Чтобы отменить блокировку, удалите строку или измените статус

---

### Сценарий 3: Праздничный день — как закрыть запись

**Ситуация:** Завтра праздничный день, нужно закрыть запись на весь день.

**Что делать:**

1. Откройте Google Sheets
2. Перейдите на лист "Расписание"
3. Добавьте новую строку
4. Заполните колонки:
   - `Дата`: дата праздника в формате `YYYY-MM-DD` (например: `2025-01-31`)
   - `Время_начала`: `00:00`
   - `Время_окончания`: `23:59`
   - `Статус`: `заблокировано`
   - `Услуга`: оставьте пустым
   - `Примечание`: `праздничный день` или `Новый год`

**Пример:**

| Дата       | Время_начала | Время_окончания | Статус        | Услуга | Примечание |
| ---------- | ------------ | --------------- | ------------- | ------ | ---------- |
| 2025-01-31 | 00:00        | 23:59           | заблокировано |        | Новый год  |

**Дополнительно:** Можно отправить массовое уведомление клиентам о закрытии салона (см. раздел "Массовая рассылка").

---

### Сценарий 4: Клиент не пришёл — как отметить

**Ситуация:** Клиент не пришёл на запись, нужно отметить это в системе.

**Что делать:**

1. Найдите запись в Google Sheets (лист "Записи") по имени/телефону/дате
2. Измените статус на `отменена`
3. В колонке `Отменено_UTC` укажите текущее время в формате ISO UTC (например: `2025-01-15T14:30:00Z`)

**Альтернативный способ через бота:**

1. Найдите код отмены записи (через "Просмотр записей" или в Google Sheets в колонке "Код_отмены")
2. Отмените запись через бота: "Отменить запись (по коду)" → введите код отмены (например: A3K9X2)

**Важно:**

- После отметки запись не будет учитываться в статистике активных записей
- Клиент получит уведомление об отмене (если отменяете через бота и у клиента есть Telegram)

---

### Сценарий 5: Нужно отправить уведомление всем клиентам

**Ситуация:** Изменилось расписание, нужно уведомить всех клиентов.

**Что делать:**

1. Откройте бота и перейдите в админ-режим (`/admin`)
2. Нажмите "Массовая рассылка"
3. Напишите текст уведомления
4. Проверьте предпросмотр (количество получателей)
5. Нажмите "Подтвердить рассылку ✅"

**Пример текста:**

```
Дорогие клиенты!

Напоминаем, что завтра, 15 января, салон работает
с 12:00 до 18:00 (сокращённый день).

Благодарим за понимание!
```

**Если нужно отправить фото (например, с акцией):**

1. Нажмите "Массовая рассылка"
2. Отправьте фото (можно добавить подпись)
3. Проверьте предпросмотр
4. Подтвердите рассылку

**Важно:**

- Забаненные клиенты автоматически исключаются
- Рассылка может занять время (примерно 200 мс на каждого получателя)
- Бот покажет статистику: сколько отправлено успешно, сколько с ошибками

---

### Сценарий 6: Изменились цены — как обновить услуги

**Ситуация:** Нужно изменить цену на услугу (например, повысили цену на стрижку).

**Что делать:**

1. Откройте бота и перейдите в админ-режим (`/admin`)
2. Нажмите "Управление услугами"
3. Нажмите "Изменить услугу"
4. Выберите услугу из списка
5. Выберите "Цена"
6. Введите новую цену (например: `1800`)
7. Бот обновит цену

**Пример:**

```
Вы: Управление услугами → Изменить услугу
    [Выбираете "Мужская стрижка"]
    [Выбираете "Цена"]

Бот: Отправьте новое значение для поля "цену (число или 'удалить' для очистки)":

Вы: 1800

Бот: Цена услуги обновлена: 1800 ₽
```

**Важно:**

- Новая цена сразу отобразится клиентам при выборе услуги
- Можно убрать цену, написав `удалить` или `нет`
- Изменение цены не влияет на уже созданные записи

---

## Автоматические функции

Бот автоматически выполняет несколько функций без вашего участия.

### Напоминания клиентам

#### Напоминание за день до записи

**Когда:** Каждый день в 10:00 по таймзоне салона

**Что происходит:** Бот отправляет напоминание клиентам, у которых запись на завтра

**Пример сообщения клиенту:**

```
Напоминание: у вас запись на завтра, 15 января, в 14:00.
Услуга: Мужская стрижка.

До встречи!
```

#### Напоминание за 2 часа до записи

**Когда:** Каждые 5 минут бот проверяет записи и отправляет напоминания за 2 часа до начала

**Что происходит:** Клиенты получают напоминание за 2 часа до своей записи

**Пример сообщения клиенту:**

```
Напоминание: у вас запись через 2 часа, в 14:00.
Услуга: Мужская стрижка.

Не забудьте!
```

**Важно:**

- Напоминания отправляются только один раз
- Если клиент заблокировал бота, напоминание не отправится
- Напоминания учитывают таймзону салона

---

### Автоматическое завершение записей

**Когда:** Каждые 30 минут бот проверяет записи

**Что происходит:** Записи, у которых время окончания уже прошло, автоматически получают статус `исполнено`

**Пример:**

Запись была на 14:00-15:00. В 15:30 бот автоматически изменит статус на `исполнено` и заполнит колонку `Исполнено_UTC` в Google Sheets.

**Важно:**

- Это происходит автоматически, ничего делать не нужно
- Завершённые записи не учитываются в списке активных записей
- Статистика обновляется автоматически

---

### Напоминания неактивным клиентам

**Когда:** Каждый день в 11:00 по таймзоне салона

**Что происходит:** Бот проверяет клиентов, которые не посещали салон более 21 дня, и отправляет им дружелюбное напоминание

**Условия для отправки:**

- Последняя завершённая запись была более 21 дня назад
- Нет активных (неотменённых) записей
- Есть telegramId для отправки сообщения
- Клиент не забанен
- Напоминание ещё не отправлялось (поле `Напоминание_21день_UTC` пустое)

**Пример сообщения клиенту:**

```
Привет! Прошло уже больше 21 дня с вашего последнего визита.
Пора обновить стрижку!

Запишитесь на удобное время через бота.
```

**Важно:**

- Напоминание отправляется только один раз
- Когда клиент создаёт новую запись, поле `Напоминание_21день_UTC` очищается, и клиент снова может получить напоминание через 21 день
- Менеджер получает отчёт о количестве отправленных напоминаний

---

## Часто задаваемые вопросы

### Что делать, если бот не отвечает?

1. **Проверьте интернет-соединение** — убедитесь, что у вас есть доступ в интернет
2. **Проверьте, запущен ли бот** — обратитесь к администратору
3. **Попробуйте перезапустить диалог** — отправьте команду `/start`
4. **Проверьте, не превысили ли лимит запросов** — если видите сообщение "Слишком много запросов", подождите минуту

**Если ничего не помогает:** Обратитесь к администратору или разработчику.

---

### Как узнать ID записи?

Есть несколько способов:

1. **Через бота:**

   - Нажмите "Просмотр записей"
   - Код отмены указан в начале каждой строки (например: `Код отмены: A3K9X2 — Мужская стрижка...`)

2. **Через Google Sheets:**

   - Откройте лист "Записи"
   - ID находится в колонке "ID_записи"

3. **Из уведомления менеджера:**
   - При создании новой записи бот отправляет уведомление менеджеру
   - В уведомлении указан ID записи

**Пример уведомления:**

```
Новая запись:
Услуга: Мужская стрижка
Дата: 15.01.2025
Время: 14:00–15:00
Клиент: Иван Петров
Телефон: +79991234567
TG: @ivan_petrov
Комментарий: нет
ID: 12345
Код отмены (служебно): A3K9X2
```

---

### Как найти Telegram ID клиента?

Есть несколько способов:

1. **Через Google Sheets:**

   - Откройте лист "Клиенты"
   - Найдите клиента по имени/телефону
   - Telegram ID находится в колонке "Telegram_ID"

2. **Через лист "Записи":**

   - Найдите запись клиента
   - Telegram ID находится в колонке "Telegram_ID"

3. **Попросить клиента:**
   - Клиент может написать боту `@userinfobot`
   - Бот покажет ID клиента

**Важно:** Telegram ID — это число (например: `123456789`), а не username (например: `@username`).

---

### Что такое код отмены и где его найти?

**Код отмены** — это 6-символьный код (буквы и цифры), который генерируется автоматически при создании записи. Он используется для быстрой отмены записи.

**Где найти код отмены:**

1. **В Google Sheets:**

   - Откройте лист "Записи"
   - Код находится в колонке "Код_отмены"

2. **В уведомлении менеджеру:**
   - При создании новой записи бот отправляет уведомление
   - В уведомлении указан код отмены

**Пример кода:** `A3K9X2`, `B7M2N5`, `C9K1L3`

**Как использовать:**

- Клиент может сообщить код по телефону
- Вы можете отменить запись через бота: "Отменить запись (по коду)" → введите код

**Важно:** Код чувствителен к регистру, но бот автоматически преобразует его в верхний регистр.

---

### Можно ли восстановить удалённую услугу?

**Нет**, удалённую услугу нельзя восстановить через бота. Если вы случайно удалили услугу:

1. Создайте новую услугу с тем же ключом и данными
2. Или обратитесь к администратору для восстановления из резервной копии

**Совет:** Перед удалением услуги убедитесь, что на неё нет активных записей.

---

### Почему клиент не получает напоминания?

Возможные причины:

1. **Клиент заблокировал бота** — бот не может отправить сообщение
2. **У клиента нет Telegram ID** — напоминания отправляются только через Telegram
3. **Неправильный Telegram ID** — проверьте в Google Sheets, что ID указан корректно
4. **Клиент забанен** — забаненные клиенты не получают напоминания

**Что делать:**

- Проверьте в Google Sheets лист "Клиенты", есть ли у клиента `Telegram_ID`
- Попросите клиента проверить, не заблокирован ли бот
- Проверьте, не забанен ли клиент (колонка `BanStatus`)

---

### Как отменить действие в админ-панели?

Если вы начали какое-то действие (например, ввод кода отмены для отмены записи) и хотите отменить:

1. Отправьте команду `/admin_cancel`
2. Бот отменит текущее действие и вернёт вас в админ-меню

**Пример:**

```
Вы: Отменить запись (по коду)

Бот: Отправьте код отмены записи (например: A3K9X2).
     Для отмены напишите /admin_cancel

Вы: /admin_cancel

Бот: Действие админа отменено.
```

---

## Безопасность и ограничения

### Rate Limiting (ограничения частоты запросов)

Бот защищён от злоупотребления через ограничение частоты запросов.

**Лимиты:**

- **Админ-команды:** максимум 10 запросов в минуту
- **Общие команды:** максимум 30 запросов в минуту
- **Сцены (процесс записи):** максимум 5 запросов в минуту

**Что происходит при превышении:**

- Бот отправляет сообщение: "Слишком много запросов. Пожалуйста, подождите немного."
- Нужно подождать минуту перед следующей попыткой

**Совет:** Не нажимайте кнопки слишком быстро. Дождитесь ответа бота перед следующим действием.

---

### Лимиты массовых рассылок

**Максимальное количество получателей:** 1000

**Что происходит при превышении:**

- Бот отклонит рассылку и сообщит об ошибке
- Нужно ограничить список получателей

**Как ограничить:**

- Забанить ненужных клиентов (они автоматически исключаются)
- Или обратиться к администратору для изменения лимита

**Важно:** Все массовые рассылки требуют подтверждения перед отправкой.

---

### Резервное копирование

Система автоматически создаёт резервные копии важных данных.

**Когда создаются бэкапы:**

- Автоматически раз в день
- При критичных операциях (бан/разбан пользователя, массовая рассылка)

**Что бэкапируется:**

- `sessions.json` — сессии пользователей
- `banned.json` — список забаненных пользователей
- `services.json` — список услуг

**Где хранятся:**

- В директории `backups/` в корне проекта
- Автоматически удаляются через 30 дней

**Важно:** Бэкапы создаются автоматически, ничего делать не нужно. Если нужен доступ к бэкапам, обратитесь к администратору.

---

### Логирование действий

Все критичные действия администратора логируются в файл `logs/security.log`.

**Что логируется:**

- Включение/выключение админ-режима
- Бан/разбан пользователей
- Отмена записей администратором
- Массовые рассылки
- Управление услугами

**Зачем это нужно:**

- Для отслеживания всех административных действий
- Для безопасности и аудита
- Для решения спорных ситуаций

**Доступ к логам:** Обратитесь к администратору, если нужен доступ к логам.

---

## Полезные команды

### Команды для администратора

- `/admin` — включить режим администратора
- `/user` — вернуться в пользовательский режим
- `/admin_cancel` — отменить текущее действие администратора
- `/start` — начать общение с начала (сбросить состояние)

### Команды для клиентов (для справки)

- `/start` — начать общение с ботом
- `/book` — записаться на услугу
- `/services` — посмотреть список услуг
- `/cancel` — отменить процесс записи

---

## Контакты и поддержка

Если у вас возникли вопросы или проблемы:

1. **Проверьте эту инструкцию** — возможно, ответ уже есть здесь
2. **Обратитесь к администратору** — для технических вопросов
3. **Проверьте логи** — если есть доступ, посмотрите `logs/security.log`

---

**Удачной работы с ботом!** 🎉
